"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var __assign=function(){return(__assign=Object.assign||function(t){for(var e,i=1,o=arguments.length;i<o;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function __values(t){var e="function"==typeof Symbol&&t[Symbol.iterator],i=0;return e?e.call(t):{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}}}function __read(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var o,r,n=i.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(o=n.next()).done;)s.push(o.value)}catch(t){r={error:t}}finally{try{o&&!o.done&&(i=n.return)&&i.call(n)}finally{if(r)throw r.error}}return s}function __spread(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(__read(arguments[e]));return t}var Waterfall=function(){function t(t,e){this.height=0,this.topItems=[],this.bottomItems=[],this.initItems=[],this.nowRow=[],this.isFirstLine=!0,this.width=e.width,this.options=e,this.add(t)}return Object.defineProperty(t.prototype,"nowRowWidth",{get:function(){var t,e,i=0;try{for(var o=__values(this.nowRow),r=o.next();!r.done;r=o.next()){i+=r.value.width}}catch(e){t={error:e}}finally{try{r&&!r.done&&(e=o.return)&&e.call(o)}finally{if(t)throw t.error}}return i},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"nowRowMinBottomItem",{get:function(){if(this.isFirstLine){var t=this.nowRow.map(function(t){return t.width});return{x:t.length>0?t.reduce(function(t,e){return t+e}):0,y:0,width:0,height:0}}return this.nowRow.sort(function(t,e){return t.y+t.height-(e.y+e.height)||t.x-e.x})[0]},enumerable:!0,configurable:!0}),t.prototype.add=function(t){console.time("waterfall"),this.initItems=this.initItems.concat(t);var e=this.calculateItemAndToItems(t);return console.timeEnd("waterfall"),e},t.prototype.calculateItemAndToItems=function(t){var e,i,o=[];try{for(var r=__values(t),n=r.next();!n.done;n=r.next()){for(var s=n.value,h=this.calculateItem(s),a=this.bottomItems.length-1;a>=0&&!(h.y+h.height>=this.bottomItems[a].y+this.bottomItems[a].height);a--);for(this.bottomItems.splice(a+1,0,h),a=this.topItems.length-1;a>=0&&!(h.y>=this.topItems[a].y);a--);this.topItems.splice(a+1,0,h),o.push(h)}}catch(t){e={error:t}}finally{try{n&&!n.done&&(i=r.return)&&i.call(r)}finally{if(e)throw e.error}}return o},t.prototype.calculateItem=function(t){var e,i;if(t.widthPercent){var o=t.padding||0;t._width=t._width||t.width,t._height=t._height||t.height,t.width=this.width*t.widthPercent,t.height=Math.min(t._height,(t.width-2*o)*(t._height/t._width),this.options.maxHeight||t._height)+2*o}Math.floor(t.width+this.nowRowWidth)>this.width&&(this.isFirstLine=!1);var r=__assign({},t,{x:this.nowRowMinBottomItem.x,y:this.nowRowMinBottomItem.y+this.nowRowMinBottomItem.height});this.height=Math.max(this.height,r.y+r.height);var n=0,s=this.nowRow.concat([r]).sort(function(t,e){return e.y+e.height-(t.y+t.height)||e.x-t.x});this.nowRow=[];try{for(var h=__values(s),a=h.next();!a.done;a=h.next()){var l=a.value;if(Math.floor(l.width+n)>this.width)break;n+=l.width,this.nowRow.push(l)}}catch(t){e={error:t}}finally{try{a&&!a.done&&(i=h.return)&&i.call(h)}finally{if(e)throw e.error}}return r},t.prototype.clear=function(){this.isFirstLine=!0,this.nowRow=[],this.topItems=[],this.bottomItems=[],this.height=0,this.initItems=[]},t.prototype.calculateAll=function(){var t=this.initItems;this.clear(),this.add(t)},t}(),throttle=function(t,e){var i,o=(new Date).getTime(),r=[];return function(){for(var n=this,s=[],h=0;h<arguments.length;h++)s[h]=arguments[h];var a=(new Date).getTime();r=s;var l=function(){clearTimeout(i),i=0,t.apply(n,r),o=(new Date).getTime()};a-o>e?l():i||(i=window.setTimeout(l,e))}},VirtualList=function(){function t(t,e){var i=e.topItems,o=e.bottomItems;this.topItems=[],this.bottomItems=[],this.offsetTop=0,this.viewItems=[],this.cbs={},this.dom=t,this.topItems=i,this.bottomItems=o,this.initOffsetTop(),this.listener=throttle(this._listener,100),window.addEventListener("scroll",this.listener.bind(this)),this._listener()}return t.prototype.initOffsetTop=function(){for(var t=this.dom,e=t.offsetTop;t.offsetParent;)e+=(t=t.offsetParent).offsetTop;this.offsetTop=e},t.prototype.setItems=function(t){var e=t.topItems,i=t.bottomItems;this.topItems=e,this.bottomItems=i,this._listener()},t.prototype._listener=function(){var t,e=this.offsetTop-window.pageYOffset,i=window.innerHeight;t=e<0?-e:e<i?0:i-e;var o=i-e,r=this.getViewItem(this.bottomItems,t,o),n=this.getViewItem(this.topItems,t,o);this.viewItems=Array.from(new Set(__spread(r,n))),this.emit("change",this.viewItems)},t.prototype.getViewItem=function(t,e,i){var o,r=0,n=t.length-1;if(0===t.length)return[];for(;;){if((o=Math.floor((r+n)/2))===r&&o!==n||o<0)return[];var s=this.getItemDirection(t[o],e,i);if(-1===s)r=o;else{if(1!==s)break;n=o}}for(var h=o;h>=0&&0===this.getItemDirection(t[h],e,i);h-=1)r=h;for(h=o;h<t.length&&0===this.getItemDirection(t[h],e,i);h+=1)n=h;return t.slice(r,n+1)},t.prototype.getItemDirection=function(t,e,i){return t.height+t.y<e-200?-1:t.y>i+200?1:0},t.prototype.clear=function(){this.topItems=[],this.bottomItems=[],this.viewItems=[]},t.prototype.on=function(t,e){this.cbs[t]?this.cbs[t].push(e):this.cbs[t]=[e]},t.prototype.emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];this.cbs[t]&&this.cbs[t].forEach(function(t){return t.apply(void 0,__spread(e))})},t}();exports.VirtualList=VirtualList,exports.Waterfall=Waterfall;
