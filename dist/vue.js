"use strict";var __assign=function(){return(__assign=Object.assign||function(t){for(var e,i=1,s=arguments.length;i<s;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function __values(t){var e="function"==typeof Symbol&&t[Symbol.iterator],i=0;return e?e.call(t):{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}}}function __read(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var s,r,o=i.call(t),h=[];try{for(;(void 0===e||e-- >0)&&!(s=o.next()).done;)h.push(s.value)}catch(t){r={error:t}}finally{try{s&&!s.done&&(i=o.return)&&i.call(o)}finally{if(r)throw r.error}}return h}function __spread(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(__read(arguments[e]));return t}var Waterfall=function(){function t(t,e){this.height=0,this.topItems=[],this.bottomItems=[],this.initItems=[],this.nowRow=[],this.isFirstLine=!0,this.width=e.width,this.options=e,this.add(t)}return Object.defineProperty(t.prototype,"nowRowWidth",{get:function(){var t,e,i=0;try{for(var s=__values(this.nowRow),r=s.next();!r.done;r=s.next()){i+=r.value.width}}catch(e){t={error:e}}finally{try{r&&!r.done&&(e=s.return)&&e.call(s)}finally{if(t)throw t.error}}return i},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"nowRowMinBottomItem",{get:function(){if(this.isFirstLine){var t=this.nowRow.map(function(t){return t.width});return{x:t.length>0?t.reduce(function(t,e){return t+e}):0,y:0,width:0,height:0}}return this.nowRow.sort(function(t,e){return t.y+t.height-(e.y+e.height)||t.x-e.x})[0]},enumerable:!0,configurable:!0}),t.prototype.add=function(t){return this.initItems=this.initItems.concat(t),this.calculateItemAndToItems(t)},t.prototype.calculateItemAndToItems=function(t){var e,i,s=[];try{for(var r=__values(t),o=r.next();!o.done;o=r.next()){for(var h=o.value,n=this.calculateItem(h),a=this.bottomItems.length-1;a>=0&&!(n.y+n.height>=this.bottomItems[a].y+this.bottomItems[a].height);a--);for(this.bottomItems.splice(a+1,0,n),a=this.topItems.length-1;a>=0&&!(n.y>=this.topItems[a].y);a--);this.topItems.splice(a+1,0,n),s.push(n)}}catch(t){e={error:t}}finally{try{o&&!o.done&&(i=r.return)&&i.call(r)}finally{if(e)throw e.error}}return s},t.prototype.calculateItem=function(t){var e,i;if(t.widthPercent){var s=t.padding||0;t._width=t._width||t.width,t._height=t._height||t.height,t.width=this.width*t.widthPercent,t.height=Math.min(t._height,(t.width-2*s)*(t._height/t._width),this.options.maxHeight||t._height)+2*s}Math.floor(t.width+this.nowRowWidth)>this.width&&(this.isFirstLine=!1);var r=__assign({},t,{x:this.nowRowMinBottomItem.x,y:this.nowRowMinBottomItem.y+this.nowRowMinBottomItem.height});this.height=Math.max(this.height,r.y+r.height);var o=0,h=this.nowRow.concat([r]).sort(function(t,e){return e.y+e.height-(t.y+t.height)||e.x-t.x});this.nowRow=[];try{for(var n=__values(h),a=n.next();!a.done;a=n.next()){var l=a.value;if(Math.floor(l.width+o)>this.width)break;o+=l.width,this.nowRow.push(l)}}catch(t){e={error:t}}finally{try{a&&!a.done&&(i=n.return)&&i.call(n)}finally{if(e)throw e.error}}return r},t.prototype.clear=function(){this.isFirstLine=!0,this.nowRow=[],this.topItems=[],this.bottomItems=[],this.height=0,this.initItems=[]},t.prototype.calculateAll=function(){var t=this.initItems;this.clear(),this.add(t)},t}(),throttle=function(t,e){var i,s=(new Date).getTime(),r=[];return function(){for(var o=this,h=[],n=0;n<arguments.length;n++)h[n]=arguments[n];var a=(new Date).getTime();r=h;var l=function(){clearTimeout(i),i=0,t.apply(o,r),s=(new Date).getTime()};a-s>e?l():i||(i=window.setTimeout(l,e))}},VirtualList=function(){function t(t,e){var i=e.topItems,s=e.bottomItems;this.topItems=[],this.bottomItems=[],this.offsetTop=0,this.viewItems=[],this.cbs={},this.dom=t,this.topItems=i,this.bottomItems=s,this.initOffsetTop(),this.listener=throttle(this._listener,100),window.addEventListener("scroll",this.listener.bind(this)),this._listener()}return t.prototype.initOffsetTop=function(){for(var t=this.dom,e=t.offsetTop;t.offsetParent;)e+=(t=t.offsetParent).offsetTop;this.offsetTop=e},t.prototype.setItems=function(t){var e=t.topItems,i=t.bottomItems;this.topItems=e,this.bottomItems=i,this._listener()},t.prototype._listener=function(){var t,e=this.offsetTop-window.pageYOffset,i=window.innerHeight;t=e<0?-e:e<i?0:i-e;var s=i-e,r=this.getViewItem(this.bottomItems,t,s),o=this.getViewItem(this.topItems,t,s);this.viewItems=Array.from(new Set(__spread(r,o))),this.emit("change",this.viewItems)},t.prototype.getViewItem=function(t,e,i){var s,r=0,o=t.length-1;if(0===t.length)return[];for(;;){if((s=Math.floor((r+o)/2))===r&&s!==o||s<0)return[];var h=this.getItemDirection(t[s],e,i);if(-1===h)r=s;else{if(1!==h)break;o=s}}for(var n=s;n>=0&&0===this.getItemDirection(t[n],e,i);n-=1)r=n;for(n=s;n<t.length&&0===this.getItemDirection(t[n],e,i);n+=1)o=n;return t.slice(r,o+1)},t.prototype.getItemDirection=function(t,e,i){return t.height+t.y<e-200?-1:t.y>i+200?1:0},t.prototype.clear=function(){this.topItems=[],this.bottomItems=[],this.viewItems=[]},t.prototype.on=function(t,e){this.cbs[t]?this.cbs[t].push(e):this.cbs[t]=[e]},t.prototype.emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];this.cbs[t]&&this.cbs[t].forEach(function(t){return t.apply(void 0,__spread(e))})},t}(),vueInstall={install:t=>{Object.defineProperty(t.prototype,"$Waterfall",{value:Waterfall}),t.component("virtualWaterfall",{props:{items:{type:Array,default:[]},maxHeight:{type:Number,default:null}},data:()=>({cacheItems:[],width:0,initialized:!1}),watch:{initialized(t){t&&this.cacheItems&&(this.add(this.cacheItems),this.cacheItems=[])}},methods:{add(t){this.initialized?(this.waterfall.add(t),this.virtualList.setItems(this.waterfall),this.update()):this.cacheItems=this.cacheItems.concat(t)},clear(){this.virtualList.clear(),this.waterfall.clear(),this.update()},update(){this.$forceUpdate()}},mounted(){this.width=this.$el.getBoundingClientRect().width,this.waterfall=new this.$Waterfall(this.items,{width:this.width,maxHeight:this.maxHeight}),this.virtualList=new VirtualList(this.$el,this.waterfall),this.initialized=!0,this.virtualList.on("change",this.update.bind(this)),this.reDraw=throttle(()=>{this.width=this.$el.getBoundingClientRect().width,this.waterfall.width=this.width,this.waterfall.calculateAll(),this.virtualList.setItems(this.waterfall),this.update()},200),window.addEventListener("resize",this.reDraw),this.observe=new MutationObserver(()=>{const{width:t}=this.$el.getBoundingClientRect();t!==this.width&&this.reDraw()}),this.observe.observe(this.$el,{attributes:!0})},destroyed(){this.observe.disconnect()},render(t){return t("div",{staticClass:"virtual-list",style:{position:"relative",height:`${this.waterfall&&this.waterfall.height}px`}},this.width?this.$scopedSlots.default({nowItems:this.virtualList?this.virtualList.viewItems:[]}):[])}})}};module.exports=vueInstall;
